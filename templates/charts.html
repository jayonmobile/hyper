<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time OHLCV Charts (v5.0.5 - addSeries Only)</title>
    <!-- Lightweight Charts v5.0.5 -->
    <script src="https://unpkg.com/lightweight-charts@5.0.5/dist/lightweight-charts.standalone.production.js"></script>
    <!-- Socket.IO Client -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <!-- Tailwind CSS (optional, for basic layout) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Styles remain the same */
        .chart-container { height: 400px; width: 100%; margin-bottom: 2rem; position: relative; }
        body { background-color: #f3f4f6; }
        .loading-overlay, .error-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background-color: rgba(255, 255, 255, 0.8); color: #6b7280; font-weight: bold; z-index: 10; padding: 1rem; text-align: center; }
        .error-overlay { color: #ef4444; }
    </style>
</head>

<body class="p-4 md:p-6">
    <h1 class="text-2xl font-bold mb-6 text-gray-700">SOL/USDC Real-time Charts (LWC v5.0.5 - addSeries)</h1>

    <div class="grid grid-cols-1 lg:grid-cols-1 gap-6">
        <!-- Chart Containers remain the same -->
        <div>
            <h2 class="text-lg font-semibold mb-2 text-gray-600">1m Timeframe</h2>
            <div id="chart-1m" class="chart-container bg-white rounded shadow"><div class="loading-overlay">Loading 1m chart...</div></div>
        </div>
        <div>
            <h2 class="text-lg font-semibold mb-2 text-gray-600">5m Timeframe</h2>
            <div id="chart-5m" class="chart-container bg-white rounded shadow"><div class="loading-overlay">Loading 5m chart...</div></div>
        </div>
        <div>
            <h2 class="text-lg font-semibold mb-2 text-gray-600">15m Timeframe</h2>
            <div id="chart-15m" class="chart-container bg-white rounded shadow"><div class="loading-overlay">Loading 15m chart...</div></div>
        </div>
    </div>

     <!-- Connection Status Indicator remains the same -->
    <div id="status-indicator" style="position: fixed; top: 10px; right: 10px; padding: 5px 10px; border-radius: 5px; font-size: 12px; font-weight: bold; color: white; z-index: 20;">Connecting...</div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM fully loaded.");

            if (typeof LightweightCharts === 'undefined' || typeof LightweightCharts.createChart !== 'function') {
                console.error("FATAL: LightweightCharts library not loaded correctly!");
                // Display error... (code omitted for brevity)
                return;
            } else {
                 console.log("LightweightCharts library seems loaded:", LightweightCharts);
            }

            const socket = io();
            const charts = {};
            const series = {};
            const timeframes = ['1m', '5m', '15m'];

            function showChartMessage(timeframe, message, isError = false) {
                // Helper function remains the same (code omitted for brevity)
                const chartContainer = document.getElementById(`chart-${timeframe}`);
                if (!chartContainer) return;
                const existingOverlay = chartContainer.querySelector('.loading-overlay, .error-overlay');
                if (existingOverlay) existingOverlay.remove();
                const overlay = document.createElement('div');
                overlay.textContent = message;
                overlay.className = isError ? 'error-overlay' : 'loading-overlay';
                chartContainer.appendChild(overlay);
            }

            // --- Function to initialize a chart (REVISED - addSeries ONLY) ---
            function initChart(timeframe) {
                const chartContainer = document.getElementById(`chart-${timeframe}`);
                const loadingOverlay = chartContainer.querySelector('.loading-overlay');
                if (!chartContainer) { console.error(`Container missing for ${timeframe}`); return; }
                if (loadingOverlay) loadingOverlay.remove();

                let chart = null;
                let candleSeries = null; // Declare series variable here

                try {
                    console.log(`[${timeframe}] Attempting to create chart...`);
                    chart = LightweightCharts.createChart(chartContainer, { /* ... options ... */
                        width: chartContainer.clientWidth || 600, height: chartContainer.clientHeight || 400,
                        layout: { background: { color: '#ffffff' }, textColor: 'rgba(31, 41, 55, 0.9)' },
                        grid: { vertLines: { color: 'rgba(229, 231, 235, 0.5)' }, horzLines: { color: 'rgba(229, 231, 235, 0.5)' } },
                        crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
                        rightPriceScale: { borderColor: 'rgba(107, 114, 128, 0.8)' },
                        timeScale: { borderColor: 'rgba(107, 114, 128, 0.8)', timeVisible: true, secondsVisible: timeframe === '1m' }
                     });

                    if (!chart) throw new Error("createChart returned invalid object.");
                    console.log(`[${timeframe}] Chart object created. Type: ${typeof chart}`, chart);

                    // --- Series Addition using addSeries ONLY ---
                    const seriesOptions = {
                         upColor: 'rgba(34, 197, 94, 0.8)', downColor: 'rgba(239, 68, 68, 0.8)',
                         borderDownColor: 'rgb(239, 68, 68)', borderUpColor: 'rgb(34, 197, 94)',
                         wickDownColor: 'rgb(239, 68, 68)', wickUpColor: 'rgb(34, 197, 94)',
                    };

                    // Check if addSeries exists
                    if (chart && typeof chart.addSeries === 'function') {
                         console.log(`[${timeframe}] Found addSeries method. Trying addSeries('Candlestick')...`);
                         // Ensure the type name ('Candlestick') is correct for v5.0.5
                         candleSeries = chart.addSeries('Candlestick', seriesOptions); // <--- Using addSeries directly
                         console.log(`[${timeframe}] addSeries('Candlestick') result:`, candleSeries);
                    } else {
                         // If addSeries doesn't exist, then something is fundamentally wrong
                         console.error(`[${timeframe}] CRITICAL: addSeries method not found on chart object. Keys:`, chart ? Object.keys(chart) : 'chart is null');
                         throw new Error("Required 'addSeries' method not found on chart object.");
                    }

                    // Check if series creation was successful
                    if (!candleSeries || typeof candleSeries.setData !== 'function') {
                        console.error(`[${timeframe}] Failed to create a valid series object or setData is missing. Series object:`, candleSeries);
                        throw new Error("Series creation failed or resulted in invalid object.");
                    }

                    console.log(`[${timeframe}] Series added successfully using addSeries.`);

                    // Store valid instances
                    charts[timeframe] = chart;
                    series[timeframe] = candleSeries;

                    // Handle resizing (remains the same)
                    const resizeObserver = new ResizeObserver(entries => {
                         if (entries.length === 0 || entries[0].target !== chartContainer) { return; }
                         const { width, height } = entries[0].contentRect;
                         const currentChart = charts[timeframe];
                         if (currentChart && typeof currentChart.applyOptions === 'function') {
                             currentChart.applyOptions({ width, height });
                         } else {
                             resizeObserver.unobserve(chartContainer);
                         }
                    });
                    resizeObserver.observe(chartContainer);

                    console.log(`[${timeframe}] Chart initialization fully completed.`);

                } catch (error) {
                     console.error(`Error during chart/series initialization for ${timeframe}:`, error);
                     showChartMessage(timeframe, `Init Error: ${error.message}. Check console.`, true);
                     if (chart && typeof chart.remove === 'function') { try { chart.remove(); } catch (e) {} }
                     return; // Stop
                }
            } // End of initChart


            // --- Initialize all charts ---
            console.log("Initializing charts...");
            timeframes.forEach(initChart);

            // --- Socket IO Event Handlers ---
            // ... (socket event handlers remain the same) ...
             socket.on('connect', () => { console.log('Socket connected:', socket.id); updateStatus(true); });
             socket.on('disconnect', (reason) => { console.log('Socket disconnected:', reason); updateStatus(false); });
             socket.on('connect_error', (err) => { console.error('Socket connection error:', err); updateStatus(false); });
             socket.on('ohlcv_update', function (all_data) {
                 timeframes.forEach(timeframe => {
                     const candleSeries = series[timeframe];
                     const chart = charts[timeframe];
                     if (!chart || !candleSeries) { return; }
                     const data = all_data[timeframe];
                     if (!data) { return; }
                     try {
                         const formattedData = data
                             .filter(d => d.time_sec != null && d.open != null && d.high != null && d.low != null && d.close != null)
                             .map(d => ({ time: d.time_sec, open: d.open, high: d.high, low: d.low, close: d.close }))
                             .sort((a, b) => a.time - b.time);

                         if (formattedData.length > 0) {
                             if (typeof candleSeries.setData === 'function') { candleSeries.setData(formattedData); }
                             else { console.warn(`setData not found on series for ${timeframe} during update.`); }
                         } else {
                             if (typeof candleSeries.setData === 'function') { candleSeries.setData([]); }
                         }
                     } catch(error) {
                         console.error(`Error updating chart data for ${timeframe}:`, error);
                         showChartMessage(timeframe, `Data Update Error: ${error.message}`, true);
                     }
                 });
             }); // End of ohlcv_update handler


            // --- Status Indicator Logic ---
            // ... (status indicator logic remains the same) ...
            const statusIndicator = document.getElementById('status-indicator');
            function updateStatus(connected) {
                if (!statusIndicator) return;
                statusIndicator.textContent = connected ? 'Connected' : 'Disconnected';
                statusIndicator.style.backgroundColor = connected ? '#10B981' : '#EF4444';
            }
            updateStatus(socket.connected);

        }); // End of DOMContentLoaded listener
    </script>

</body>
</html>